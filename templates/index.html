<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced BMS Tool</title>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.2/socket.io.js"></script> -->
    <style>
        :root {
            --primary-bg: #f8fafc;
            --sidebar-bg: #1e293b;
            --sidebar-item-bg: #334155;
            --sidebar-item-hover-bg: #475569;
            --sidebar-text: #f1f5f9;
            --sidebar-link-text: #cbd5e1;
            --main-header-text: #1e293b;
            --section-header-text: #0f172a;
            --border-color: #e2e8f0;
            --white: #ffffff;
            --btn-primary-bg: #3b82f6;
            --btn-update-bg: #10b981;
            --btn-secondary-bg: #64748b;
            --btn-danger-bg: #ef4444;
            --accent-color: #8b5cf6;
            --success-color: #059669;
            --warning-color: #d97706;
            --error-color: #dc2626;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--primary-bg);
            color: #374151;
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }

        .app-header {
            background: linear-gradient(135deg, var(--sidebar-bg), var(--accent-color));
            color: var(--white);
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-md);
            z-index: 1000;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .back-to-projects {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            color: var(--white);
            padding: 0.5rem 1rem;
            text-decoration: none;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            font-weight: 500;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .back-to-projects:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .project-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .app-layout {
            display: flex;
            height: calc(100vh - 60px); /* Subtract header height */
        }

        .sidebar {
            width: 320px;
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
            flex-shrink: 0;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar h2 {
            margin: 0 0 1.5rem 0;
            font-size: 1.125rem;
            font-weight: 600;
            text-align: center;
            color: var(--sidebar-text);
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .search-bar {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-color: var(--sidebar-item-bg);
            color: var(--sidebar-text);
            box-sizing: border-box;
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .search-bar::placeholder {
            color: var(--sidebar-link-text);
        }

        .search-bar:focus {
            outline: none;
            border-color: var(--btn-primary-bg);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .panel-list {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
            flex-grow: 1;
            scrollbar-width: thin;
            scrollbar-color: var(--sidebar-item-hover-bg) transparent;
        }

        .panel-list::-webkit-scrollbar {
            width: 6px;
        }

        .panel-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .panel-list::-webkit-scrollbar-thumb {
            background-color: var(--sidebar-item-hover-bg);
            border-radius: 3px;
        }

        .panel-list details {
            margin-bottom: 0.5rem;
        }

        .panel-list summary {
            cursor: pointer;
            padding: 0.75rem;
            background-color: var(--sidebar-item-bg);
            border-radius: 0.5rem;
            font-weight: 500;
            list-style: none;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            position: relative;
            font-size: 0.875rem;
        }
        
        .panel-list summary::-webkit-details-marker { 
            display: none; 
        }

        .panel-list summary::before {
            content: '▶';
            position: absolute;
            right: 0.75rem;
            transition: transform 0.2s ease;
            font-size: 0.75rem;
            color: var(--sidebar-link-text);
        }

        .panel-list details[open] summary::before {
            transform: rotate(90deg);
        }

        .panel-list summary:hover {
            background-color: var(--sidebar-item-hover-bg);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        
        .panel-list summary.active {
            background-color: var(--btn-primary-bg);
            border-color: var(--btn-primary-bg);
            box-shadow: var(--shadow-sm);
        }

        .equipment-sublist {
            list-style: none;
            padding: 0.75rem 0 0.5rem 1.5rem;
            margin: 0;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 0 0 0.5rem 0.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .equipment-sublist li {
            margin-bottom: 0.25rem;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 0.375rem;
            transition: all 0.2s ease;
            font-size: 0.8rem;
            border-left: 3px solid transparent;
        }

        .equipment-sublist li:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-left-color: var(--btn-primary-bg);
            transform: translateX(2px);
        }

        .equipment-sublist li.selected {
            background-color: var(--btn-primary-bg);
            border-left-color: var(--white);
            font-weight: 500;
        }

        .active-users {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .active-users h4 {
            margin: 0 0 1rem 0;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--sidebar-link-text);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .user-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .user-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background-color: var(--sidebar-item-bg);
            border-radius: 0.375rem;
            font-size: 0.8rem;
            color: var(--sidebar-link-text);
        }

        .user-indicator::before {
            content: '●';
            color: var(--success-color);
            font-size: 0.75rem;
        }

        .equipment-sublist li a {
            color: var(--sidebar-link-text);
            text-decoration: none;
            display: block;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            width: 100%;
            box-sizing: border-box;
        }

        .equipment-sublist li a:hover, .equipment-sublist li a.active {
            background-color: transparent;
            color: var(--sidebar-text);
        }

        .sidebar-footer {
            margin-top: auto;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }



        .user-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .user-indicator {
            background: var(--btn-update-bg);
            color: var(--white);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .user-indicator::before {
            content: "●";
            color: #4ade80;
        }

        .notifications {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            width: 300px;
        }

        .notification {
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.user-action {
            border-left: 4px solid var(--btn-primary-bg);
        }

        .notification.user-joined {
            border-left: 4px solid var(--btn-update-bg);
        }

        .notification.user-left {
            border-left: 4px solid var(--btn-danger-bg);
        }

        .notification-header {
            font-weight: bold;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .notification-message {
            font-size: 14px;
            color: var(--text-primary);
        }

        .real-time-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--btn-update-bg);
            color: var(--white);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: none;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .real-time-indicator.connected::before {
            content: "●";
            color: #4ade80;
            animation: pulse 2s infinite;
        }

        .real-time-indicator.disconnected {
            background: var(--btn-danger-bg);
        }

        .real-time-indicator.disconnected::before {
            content: "●";
            color: #fca5a5;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            box-shadow: var(--shadow-sm);
            min-height: 2.5rem;
            box-sizing: border-box;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }

        .btn-block {
            display: block;
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--btn-primary-bg), #2563eb);
            color: var(--white);
        }
        .btn-primary:hover { 
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
        }

        .btn-update {
            background: linear-gradient(135deg, var(--btn-update-bg), #059669);
            color: var(--white);
        }
        .btn-update:hover { 
            background: linear-gradient(135deg, #059669, #047857);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--btn-secondary-bg), #475569);
            color: var(--white);
        }
        .btn-secondary:hover { 
            background: linear-gradient(135deg, #475569, #334155);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--btn-danger-bg), #dc2626);
            color: var(--white);
        }
        .btn-danger:hover { 
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }

        .btn-link {
            background: transparent;
            color: var(--btn-primary-bg);
            text-decoration: none;
            border: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }
        .btn-link:hover {
            background-color: var(--primary-bg);
            border-color: var(--btn-primary-bg);
        }

        .main-content {
            flex-grow: 1;
            padding: 0;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            background-color: var(--white);
        }

        .presets-panel {
            width: 300px;
            background-color: #f8fafc;
            color: var(--text-primary);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
            flex-shrink: 0;
            border-left: 1px solid var(--border-color);
            overflow-y: auto;
        }

        .presets-panel h2 {
            margin: 0 0 1.5rem 0;
            font-size: 1.125rem;
            font-weight: 600;
            text-align: center;
            color: var(--text-primary);
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .preset-item {
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .preset-item:hover {
            border-color: var(--btn-primary-bg);
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .preset-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .preset-details {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .preset-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .preset-actions button {
            flex: 1;
            padding: 0.375rem 0.5rem;
            font-size: 0.75rem;
        }

        .empty-presets {
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
            margin-top: 2rem;
        }

        .content-header {
            background: linear-gradient(135deg, var(--white), #f8fafc);
            padding: 2rem;
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .content-header h1 {
            margin: 0 0 0.5rem 0;
            font-size: 2rem;
            font-weight: 700;
            color: var(--main-header-text);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .content-header-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .content-body {
            flex-grow: 1;
            padding: 2rem;
            overflow-y: auto;
        }



        .stage {
            background-color: var(--white);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .stage h3 {
            margin: 0 0 1.5rem 0;
            color: var(--section-header-text);
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stage h3::before {
            content: '📝';
            font-size: 1.25rem;
        }

        #form-title {
            margin-top: 0;
            color: var(--section-header-text);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--section-header-text);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            background-color: var(--white);
            box-sizing: border-box;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--btn-primary-bg);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }

        input::placeholder {
            color: #9ca3af;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            background-color: var(--primary-bg);
            padding: 15px;
            border-radius: 4px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
        }

        #point-configuration {
            display: none;
            margin-top: 20px;
        }

        #point-configuration h4 {
            margin-bottom: 10px;
        }

        #submit-button-container {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
        }

        .point-summary {
            font-size: 12px;
            color: #aed9ff;
            padding: 5px 10px;
            background: #2a4b6d;
            border-radius: 4px;
            margin-top: 5px;
        }
        .point-summary span {
            margin-right: 10px;
        }

        /* --- Modal CSS --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: var(--white);
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 800px;
            box-shadow: var(--shadow-lg);
            position: relative;
            border: 1px solid var(--border-color);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--main-header-text);
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-close-btn {
            font-size: 1.5rem;
            font-weight: bold;
            border: none;
            background: none;
            cursor: pointer;
            color: #6b7280;
            width: 2rem;
            height: 2rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close-btn:hover {
            background-color: #f3f4f6;
            color: var(--error-color);
        }

        .modal-body {
            display: flex;
            gap: 2rem;
            max-height: 60vh;
        }

        .modal-list-pane {
            flex: 1;
            min-width: 300px;
            flex-shrink: 0;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-form-pane {
            flex: 1;
            min-width: 350px;
            flex-shrink: 1;
            position: sticky;
            top: 0;
            height: fit-content;
        }

        #template-list li,
        #points-list li {
            list-style: none;
            padding: 10px;
            background-color: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 5px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #template-list li:hover,
        #points-list li:hover {
            background-color: #e9ecef;
        }

        #template-list li.active,
        #points-list li.active {
            background-color: var(--btn-primary-bg);
            color: #fff;
            font-weight: bold;
        }

        .list-item-controls button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            margin-left: 8px;
            visibility: hidden;
        }
        .list-item-controls button:hover { transform: scale(1.2); }

        #template-list li:hover .list-item-controls,
        #points-list li:hover .list-item-controls {
            visibility: visible;
        }

        #master-point-list {
            max-height: 300px;
            overflow-y: auto;
            background-color: var(--white);
            border: 1px solid var(--border-color);
            padding: 15px;
            border-radius: 4px;
        }

        .point-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .point-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
        }
        .point-list li:last-child { border-bottom: none; }

        .point-list button {
            font-size: 18px;
            cursor: pointer;
            background: none;
            border: none;
        }

        #available-points-search {
            width: 100%;
            margin-bottom: 10px;
        }

        .modal-footer {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-row.single {
            grid-template-columns: 1fr;
        }

        .form-row.triple {
            grid-template-columns: 2fr 1fr;
        }

        #parts-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            max-height: calc(60vh - 150px);
            overflow-y: auto;
            display: block;
        }
        
        #parts-table thead,
        #parts-table tbody {
            display: table;
            width: 100%;
            table-layout: fixed;
        }
        
        #parts-table tbody {
            display: block;
            max-height: calc(60vh - 150px);
            overflow-y: auto;
        }
        
        #parts-table tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }
        
        #parts-table th, #parts-table td {
            border: 1px solid var(--border-color);
            padding: 8px;
            text-align: left;
            width: 25%;
        }
        #parts-table th {
            background-color: var(--sidebar-item-bg);
            color: var(--sidebar-text);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        #parts-table tbody tr:nth-child(even) { background-color: #e9ecef; }
        #parts-table tbody tr:hover { background-color: #d9e2ef; cursor: pointer; }

    </style>
</head>
<body>
    <!-- App Header -->
    <header class="app-header">
        <div class="header-left">
            <a href="/projects" class="back-to-projects">
                ← Back to Projects
            </a>
            <h1 class="project-title">BMS Project Workspace</h1>
        </div>
        <div class="header-right">
            <a href="{{ url_for('logout') }}" class="btn btn-danger">Logout</a>
        </div>
    </header>

    <div class="app-layout">
        <aside class="sidebar">
            <h2>Panel Overview</h2>
            <input type="search" id="search-bar" class="search-bar" placeholder="🔍 Search equipment...">
            <ul id="panel-list" class="panel-list"></ul>
            <div class="active-users">
                <h4>👥 Active Users</h4>
                <div id="active-users-list" class="user-list">
                    <div class="user-indicator">Just you</div>
                </div>
            </div>
            <div class="sidebar-footer">
                <button id="add-panel-btn" class="btn btn-secondary btn-block">+ Add New Panel</button>
                <button id="project-summary-btn" class="btn btn-primary btn-block">📊 Project Summary</button>
            </div>
        </aside>
        <main class="main-content">
            <div class="content-header">
                <h1 id="main-header">🏗️ Workspace</h1>
                <div class="content-header-actions">
                    <button id="manage-library-btn" class="btn btn-link">⚙️ Manage Equipment & Point Libraries</button>
                    <button id="manage-parts-btn" class="btn btn-link">🔩 Manage Parts</button>
                </div>
            </div>
            <div class="content-body">
                <div class="stage">
                    <h3 id="form-title">Add New Equipment</h3>
                    <form id="equipment-form">
                        <input type="hidden" id="editing-id">
                        <div class="form-row">
                            <div class="form-group"><label for="panel-name">Panel Name</label><input type="text" id="panel-name" placeholder="Select a panel" required></div>
                            <div class="form-group"><label for="floor-name">Floor</label><input type="text" id="floor-name" placeholder="Select a panel" required></div>
                        </div>
                        <div class="form-row triple">
                            <div class="form-group"><label for="instance-name">Equipment Instance Name</label><input type="text" id="instance-name" placeholder="e.g., AHU-01" required></div>
                            <div class="form-group"><label for="quantity">Quantity</label><input type="number" id="quantity" value="1" min="1" required></div>
                        </div>
                        <div class="form-group"><label for="equipment-type">Equipment Type</label><select id="equipment-type" required><option value="">--- Select ---</option></select></div>
                        <div id="point-configuration"><h4>Configure Points</h4><div id="checkbox-container" class="checkbox-group"></div></div>
                        <div id="submit-button-container">
                            <button type="submit" class="btn btn-primary">Add Equipment to Schedule</button>
                            <button type="button" id="save-preset-btn" class="btn btn-success" style="margin-left: 10px;">Save as Preset</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
        <aside class="presets-panel">
            <h2>📋 Equipment Presets</h2>
            <div id="presets-container">
                <div class="empty-presets">No presets available</div>
            </div>
        </aside>
    </div>

    <div id="add-panel-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header"><h2>Add New Panel</h2><button class="modal-close-btn">&times;</button></div>
            <form id="add-panel-form">
                <div class="form-group"><label for="new-panel-name">Panel Name</label><input type="text" id="new-panel-name" required></div>
                <div class="form-group"><label for="new-panel-floor">Floor</label><input type="text" id="new-panel-floor" required></div>
                <div class="modal-footer" style="justify-content: flex-end;"><button type="submit" class="btn btn-primary">Save Panel</button></div>
            </form>
        </div>
    </div>
    
    <div id="equipment-library-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h2>Manage Equipment Library</h2><button class="modal-close-btn">&times;</button></div>
            <div class="modal-body">
                <div class="modal-list-pane">
                    <h4>Equipment Types</h4>
                    <ul id="template-list"></ul>
                    <button id="new-template-btn" class="btn btn-secondary" style="width: 100%; margin-top: 10px;">+ New Type</button>
                </div>
                <div class="modal-form-pane">
                    <form id="template-form">
                        <input type="hidden" id="editing-template-key">
                        <h4 id="template-form-title">Add New Equipment Type</h4>
                        <div class="form-row">
                            <div class="form-group"><label for="template-name">Display Name</label><input type="text" id="template-name" required></div>
                            <div class="form-group"><label for="template-key">Type Key</label><input type="text" id="template-key" required></div>
                        </div>
                        <div class="form-group">
                            <label for="template-category">Category</label>
                            <input type="text" id="template-category" placeholder="e.g., Air Handling Units, Fan Coil Units, Pumps">
                        </div>
                        <div class="form-group">
                            <label>Assigned Points</label>
                            <ul id="assigned-points-list" class="point-list"></ul>
                        </div>
                        <div class="form-group">
                            <label>Available Points</label>
                            <button type="button" id="manage-points-btn" class="btn-link" style="font-size: 12px; margin-left: 10px;">(Manage Point Library)</button>
                            <input type="text" id="available-points-search" placeholder="Search available points...">
                            <ul id="available-points-list" class="point-list"></ul>
                        </div>
                        <div class="modal-footer"><button type="submit" class="btn btn-primary">Save Template</button></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="points-library-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h2>Manage Points Library</h2><button class="modal-close-btn">&times;</button></div>
            <div class="modal-body">
                <div class="modal-list-pane">
                    <h4>All Points</h4>
                    <ul id="points-list"></ul>
                    <button id="new-point-btn" class="btn btn-secondary" style="width: 100%; margin-top: 10px;">+ New Point</button>
                </div>
                <div class="modal-form-pane">
                    <form id="point-form">
                        <input type="hidden" id="editing-point-id">
                        <h4 id="point-form-title">Add New Point</h4>
                        <div class="form-group">
                            <label for="point-name">Point Name</label>
                            <input type="text" id="point-name" required>
                        </div>
                        <div class="form-group">
                            <label for="point-part-number">Part Number</label>
                            <div style="display: flex; gap: 10px;">
                                <select id="point-part-number" style="flex-grow: 1;"><option value="">None</option></select>
                                <button type="button" id="edit-part-btn" class="btn btn-secondary">Edit</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="point-quantity">Quantity</label>
                            <input type="number" id="point-quantity" value="1" min="1" required>
                        </div>
                        <div id="sub-points-container"></div>
                        <div class="modal-footer">
                            <button type="button" id="delete-point-btn" class="btn btn-danger" style="visibility: hidden;">Delete</button>
                            <button type="submit" class="btn btn-primary">Save Point</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="parts-library-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="modal-header"><h2>Manage Parts Library</h2><button class="modal-close-btn">&times;</button></div>
            <div class="modal-body">
                <div class="modal-list-pane">
                    <input type="text" id="parts-search" class="search-bar" placeholder="Search parts..." style="color: var(--sidebar-text); background-color: var(--sidebar-item-bg);">
                    <table id="parts-table">
                        <thead>
                            <tr>
                                <th>Part Number</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th>Cost</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <button id="new-part-btn" class="btn btn-secondary" style="width: 100%; margin-top: 10px;">+ New Part</button>
                </div>
                <div class="modal-form-pane">
                    <form id="part-form">
                        <input type="hidden" id="editing-part-id">
                        <h4 id="part-form-title">Add New Part</h4>
                        <div class="form-group">
                            <label for="part-number">Part Number</label>
                            <input type="text" id="part-number" required>
                        </div>
                        <div class="form-group">
                            <label for="part-description">Description</label>
                            <input type="text" id="part-description" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="part-category">Category</label>
                                <input type="text" id="part-category">
                            </div>
                            <div class="form-group">
                                <label for="part-cost">Cost</label>
                                <input type="number" id="part-cost" min="0" step="0.01">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="part-country">Country of Origin</label>
                                <input type="text" id="part-country">
                            </div>
                            <div class="form-group">
                                <label for="part-cable">Cable Recommendation</label>
                                <input type="text" id="part-cable">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" id="delete-part-btn" class="btn btn-danger" style="visibility: hidden;">Delete</button>
                            <button type="submit" class="btn btn-primary">Save Part</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="delete-panel-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>⚠️ Delete Panel</h2>
                <button class="modal-close-btn" onclick="document.getElementById('cancel-delete-panel').click()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="delete-panel-warning" style="color: var(--danger-color); font-size: 0.9rem; margin-bottom: 1rem;"></p>
                <div class="form-group">
                    <label for="delete-panel-confirm">Type the panel name to confirm:</label>
                    <input type="text" id="delete-panel-confirm" placeholder="Panel name" />
                </div>
                <div class="form-group">
                    <label for="delete-panel-confirm-word">Type DELETE to confirm:</label>
                    <input type="text" id="delete-panel-confirm-word" placeholder="DELETE" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="cancel-delete-panel">Cancel</button>
                <button type="button" id="confirm-delete-panel" class="btn btn-danger">Delete Permanently</button>
            </div>
        </div>
    </div>

    <!-- Rename Panel Modal -->
    <div id="rename-panel-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>✏️ Rename Panel</h2>
                <button class="modal-close-btn" onclick="hideRenamePanelModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="rename-panel-info" style="color: var(--text-secondary); margin-bottom: 1rem;"></p>
                <div class="form-group">
                    <label for="rename-panel-input">New Panel Name:</label>
                    <input type="text" id="rename-panel-input" placeholder="Enter new panel name" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="hideRenamePanelModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmPanelRename()">Rename Panel</button>
            </div>
        </div>
    </div>

    <!-- Save Preset Modal -->
    <div id="save-preset-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Save Equipment Preset</h2>
                <button class="modal-close-btn">&times;</button>
            </div>
            <form id="save-preset-form">
                <div class="form-group">
                    <label for="preset-name">Preset Name</label>
                    <input type="text" id="preset-name" placeholder="e.g., Standard AHU Configuration" required>
                </div>
                <div class="form-group">
                    <label>Equipment Details</label>
                    <div id="preset-equipment-summary" style="padding: 10px; background: #f8f9fa; border-radius: 4px; font-size: 0.9rem;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeSavePresetModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Preset</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Apply Preset Modal -->
    <div id="apply-preset-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Apply Equipment Preset</h2>
                <button class="modal-close-btn">&times;</button>
            </div>
            <form id="apply-preset-form">
                <input type="hidden" id="apply-preset-id">
                <div class="form-group">
                    <label>Preset Details</label>
                    <div id="apply-preset-summary" style="padding: 10px; background: #f8f9fa; border-radius: 4px; font-size: 0.9rem;"></div>
                </div>
                <div class="form-group">
                    <label for="apply-panel-select">Select Panel</label>
                    <select id="apply-panel-select" required>
                        <option value="">--- Select Panel ---</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="apply-instance-name">Equipment Instance Name</label>
                    <input type="text" id="apply-instance-name" placeholder="e.g., AHU-02" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeApplyPresetModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Apply Preset</button>
                </div>
            </form>
        </div>
    </div>

<script>
    const projectId = {{ project_id }};
    // Socket.io disabled for testing - would work in production with proper CDN access
    // const socket = io();
    
    // Mock socket functionality for testing
    const socket = {
        on: function() {},
        emit: function() {}
    };

    socket.on('connect', () => {
        socket.emit('join', { project_id: projectId });
    });

    // Listen for project-scoped data changes (existing behavior retained elsewhere if added later)
    socket.on('update', async (payload) => {
        if (ignoreNextSocketUpdate) { ignoreNextSocketUpdate = false; return; }
        const preservedType = form["equipment-type"].value;
        // Lightweight full refresh for now (unchanged logic) - could be optimized later
        const updated = await apiCall(`/api/data/${projectId}`);
        appData.panels = updated.panels;
        appData.scheduledEquipment = updated.scheduledEquipment;
        appData.pointTemplates = updated.pointTemplates;
        appData.equipmentTemplates = updated.equipmentTemplates;
        appData.parts = updated.parts;
        renderSidebar();
        populateEquipmentTypes();
        if (preservedType && appData.equipmentTemplates[preservedType]) {
            form["equipment-type"].value = preservedType;
        }
    });

    // Listen for global catalog updates (points, equipment templates, parts)
    socket.on('global_catalog_update', async () => {
        try {
            const preservedType = form["equipment-type"].value;
            const [templates, points] = await Promise.all([
                apiCall('/api/equipment_templates'),
                apiCall('/api/point_templates')
            ]);
            // Merge into appData keeping existing panels / scheduled equipment
            appData.equipmentTemplates = templates;
            appData.pointTemplates = points;
            // Parts may also change; reuse /api/data or create a dedicated /api/parts later.
            // For now fetch parts from /api/data minimal call (could be its own endpoint later)
            const partial = await apiCall(`/api/data/${projectId}`); // reuse to get parts only
            appData.parts = partial.parts;
            populateEquipmentTypes();
            if (preservedType) {
                // If key still exists after rename edits, restore it. If template was renamed, we can't infer new key here.
                if (appData.equipmentTemplates[preservedType]) {
                    form["equipment-type"].value = preservedType;
                }
            }
            // If a template edit modal is open, re-render its lists without losing selection
            if (equipmentLibraryModal.style.display === 'flex') {
                const activeTemplate = editingTemplateKeyInput.value || null;
                renderEquipmentLibraryModal();
                if (activeTemplate) loadTemplateForEdit(activeTemplate);
            }
            if (pointsLibraryModal.style.display === 'flex') {
                const activePoint = editingPointIdInput.value || null;
                renderPointsModal();
                if (activePoint) loadPointForEdit(activePoint);
            }
        } catch (e) {
            console.warn('Failed to refresh global catalog incrementally, falling back to full reload.', e);
        }
    });

    // --- GLOBAL STATE & DOM REFS ---
    let appData = {
        panels: [],
        scheduledEquipment: [],
        pointTemplates: {},
        equipmentTemplates: {},
        parts: {},
        presets: []
    };
    const panelList = document.getElementById("panel-list"),
        searchBar = document.getElementById("search-bar"),
        form = document.getElementById("equipment-form"),
        equipmentTypeSelect = document.getElementById("equipment-type"),
        pointConfigContainer = document.getElementById("point-configuration"),
        checkboxContainer = document.getElementById("checkbox-container"),
        formTitle = document.getElementById("form-title"),
        mainHeader = document.getElementById("main-header"),
        submitButtonContainer = document.getElementById("submit-button-container"),
        editingIdInput = document.getElementById("editing-id"),
        panelNameInput = document.getElementById("panel-name"),
        floorNameInput = document.getElementById("floor-name"),
        addPanelBtn = document.getElementById("add-panel-btn"),
        projectSummaryBtn = document.getElementById("project-summary-btn"),
        manageLibraryBtn = document.getElementById("manage-library-btn"),
        quantityInput = document.getElementById("quantity");
    const addPanelModal = document.getElementById("add-panel-modal"),
        addPanelForm = document.getElementById("add-panel-form");
    const equipmentLibraryModal = document.getElementById("equipment-library-modal"),
        templateList = document.getElementById("template-list"),
        newTemplateBtn = document.getElementById("new-template-btn"),
        templateForm = document.getElementById("template-form"),
        templateFormTitle = document.getElementById("template-form-title"),
        editingTemplateKeyInput = document.getElementById("editing-template-key"),
        managePointsBtn = document.getElementById("manage-points-btn");
    const pointsLibraryModal = document.getElementById("points-library-modal"),
        pointsList = document.getElementById("points-list"),
        newPointBtn = document.getElementById("new-point-btn"),
        pointForm = document.getElementById("point-form"),
        pointFormTitle = document.getElementById("point-form-title"),
        editingPointIdInput = document.getElementById("editing-point-id"),
        deletePointBtn = document.getElementById("delete-point-btn"),
        editPartBtn = document.getElementById("edit-part-btn");
    const assignedPointsList = document.getElementById('assigned-points-list'),
        availablePointsList = document.getElementById('available-points-list'),
        availablePointsSearch = document.getElementById('available-points-search');
    const subPointsContainer = document.getElementById('sub-points-container');
    const managePartsBtn = document.getElementById("manage-parts-btn"),
        partsLibraryModal = document.getElementById("parts-library-modal"),
        partsSearch = document.getElementById("parts-search"),
        partsTableBody = document.querySelector("#parts-table tbody"),
        partForm = document.getElementById("part-form"),
        partFormTitle = document.getElementById("part-form-title"),
        editingPartIdInput = document.getElementById("editing-part-id"),
        newPartBtn = document.getElementById("new-part-btn"),
        deletePartBtn = document.getElementById("delete-part-btn");

    let sidebarRenderToken = 0;
    let ignoreNextSocketUpdate = false;

    // --- API & DATA ---

    async function apiCall(url, method = "GET", body = null) {
        try {
            const options = {
                method,
                headers: {
                    "Content-Type": "application/json"
                }
            };
            if (body) {
                options.body = JSON.stringify(body);
            }
            const response = await fetch(url, options);
            if (!response.ok) {
                const err = await response.json().catch(() => ({
                    error: "An unknown server error occurred."
                }));
                throw new Error(err.error || `Server responded with status ${response.status}`);
            }
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                return await response.json();
            }
            return null;
        } catch (error) {
            console.error(`API call failed for ${method} ${url}:`, error);
            alert(`Error: ${error.message}`);
            throw error;
        }
    }
    async function loadInitialData() {
        appData = await apiCall(`/api/data/${projectId}`);
        renderSidebar();
        populateEquipmentTypes();
        populatePartSelector();
        resetForm();
        renderPartsModal();
        renderPresets();
    }

    // --- MODAL GENERIC HANDLERS ---
    function setupModal(modal, openBtn, closeSelector, onOpen = null) {
        const closeBtns = modal.querySelectorAll(closeSelector);
        if(openBtn) openBtn.addEventListener("click", () => {
            if (onOpen) {
                onOpen();
            }
            modal.style.display = "flex";
        });
        closeBtns.forEach(btn => btn.addEventListener("click", () => modal.style.display = "none"));
    }
    setupModal(addPanelModal, addPanelBtn, ".modal-close-btn");
    setupModal(equipmentLibraryModal, manageLibraryBtn, ".modal-close-btn", renderEquipmentLibraryModal);
    setupModal(pointsLibraryModal, managePointsBtn, ".modal-close-btn", renderPointsModal);
    setupModal(partsLibraryModal, managePartsBtn, ".modal-close-btn", renderPartsModal);

    // --- PRESET FUNCTIONALITY ---
    function renderPresets() {
        const container = document.getElementById('presets-container');
        if (!appData.presets || appData.presets.length === 0) {
            container.innerHTML = '<div class="empty-presets">No presets available</div>';
            return;
        }

        container.innerHTML = appData.presets.map(preset => `
            <div class="preset-item">
                <div class="preset-name">${preset.name}</div>
                <div class="preset-details">
                    ${preset.equipment_name} (Qty: ${preset.quantity})<br>
                    ${preset.selectedPoints.length} points selected
                </div>
                <div class="preset-actions">
                    <button class="btn btn-primary" onclick="showApplyPresetModal(${preset.id})">Apply</button>
                    <button class="btn btn-danger" onclick="deletePreset(${preset.id})">Delete</button>
                </div>
            </div>
        `).join('');
    }

    function showSavePresetModal() {
        // Validate form before showing modal
        const equipmentType = document.getElementById('equipment-type').value;
        const instanceName = document.getElementById('instance-name').value.trim();
        const quantity = document.getElementById('quantity').value;

        if (!equipmentType || !instanceName) {
            alert('Please fill in all required equipment fields before saving as preset.');
            return;
        }

        // Get selected points
        const selectedPoints = getSelectedPoints();
        if (selectedPoints.length === 0) {
            alert('Please select at least one point before saving as preset.');
            return;
        }

        // Populate summary
        const equipmentTemplate = appData.equipmentTemplates[equipmentType];
        const summary = `
            <strong>Equipment:</strong> ${equipmentTemplate.name}<br>
            <strong>Quantity:</strong> ${quantity}<br>
            <strong>Selected Points:</strong> ${selectedPoints.length} points
        `;
        document.getElementById('preset-equipment-summary').innerHTML = summary;
        
        document.getElementById('save-preset-modal').style.display = 'flex';
    }

    function closeSavePresetModal() {
        document.getElementById('save-preset-modal').style.display = 'none';
        document.getElementById('preset-name').value = '';
    }

    function showApplyPresetModal(presetId) {
        const preset = appData.presets.find(p => p.id === presetId);
        if (!preset) return;

        // Populate preset details
        const summary = `
            <strong>Preset:</strong> ${preset.name}<br>
            <strong>Equipment:</strong> ${preset.equipment_name}<br>
            <strong>Quantity:</strong> ${preset.quantity}<br>
            <strong>Points:</strong> ${preset.selectedPoints.length} selected
        `;
        document.getElementById('apply-preset-summary').innerHTML = summary;
        document.getElementById('apply-preset-id').value = presetId;

        // Populate panel options
        const panelSelect = document.getElementById('apply-panel-select');
        panelSelect.innerHTML = '<option value="">--- Select Panel ---</option>' +
            appData.panels.map(panel => 
                `<option value="${panel.id}">${panel.panelName} (${panel.floor})</option>`
            ).join('');

        document.getElementById('apply-preset-modal').style.display = 'flex';
    }

    function closeApplyPresetModal() {
        document.getElementById('apply-preset-modal').style.display = 'none';
        document.getElementById('apply-instance-name').value = '';
        document.getElementById('apply-panel-select').value = '';
    }

    async function deletePreset(presetId) {
        const preset = appData.presets.find(p => p.id === presetId);
        if (!preset) return;
        
        if (!confirm(`Are you sure you want to delete the preset "${preset.name}"?`)) return;

        try {
            await apiCall(`/api/projects/${projectId}/presets/${presetId}`, 'DELETE');
            appData = await apiCall(`/api/data/${projectId}`);
            renderPresets();
        } catch (error) {
            alert('Error deleting preset: ' + error.message);
        }
    }

    // Save Preset Form Handler
    document.getElementById('save-preset-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const presetName = document.getElementById('preset-name').value.trim();
        if (!presetName) return;

        const equipmentType = document.getElementById('equipment-type').value;
        const quantity = parseInt(document.getElementById('quantity').value);
        const selectedPoints = getSelectedPoints();

        try {
            await apiCall(`/api/projects/${projectId}/presets`, 'POST', {
                name: presetName,
                equipment_template_id: appData.equipmentTemplates[equipmentType].id,
                quantity: quantity,
                selectedPoints: selectedPoints
            });
            
            appData = await apiCall(`/api/data/${projectId}`);
            renderPresets();
            closeSavePresetModal();
        } catch (error) {
            alert('Error saving preset: ' + error.message);
        }
    });

    // Apply Preset Form Handler
    document.getElementById('apply-preset-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const presetId = document.getElementById('apply-preset-id').value;
        const panelId = document.getElementById('apply-panel-select').value;
        const instanceName = document.getElementById('apply-instance-name').value.trim();

        if (!panelId || !instanceName) return;

        try {
            await apiCall(`/api/projects/${projectId}/presets/${presetId}/apply`, 'POST', {
                panel_id: parseInt(panelId),
                instance_name: instanceName
            });
            
            appData = await apiCall(`/api/data/${projectId}`);
            renderSidebar();
            closeApplyPresetModal();
        } catch (error) {
            alert('Error applying preset: ' + error.message);
        }
    });

    // Helper function to get selected points
    function getSelectedPoints() {
        const checkboxContainer = document.getElementById('checkbox-container');
        return Array.from(checkboxContainer.querySelectorAll("input:checked")).map(cb => parseInt(cb.value));
    }

    // Close modals when clicking outside
    document.getElementById('save-preset-modal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) {
            closeSavePresetModal();
        }
    });

    document.getElementById('apply-preset-modal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) {
            closeApplyPresetModal();
        }
    });

    // --- PANEL LOGIC (single optimistic handler) ---
    addPanelForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const panelName = document.getElementById('new-panel-name').value.trim();
        const floor = document.getElementById('new-panel-floor').value.trim();
        if(!panelName || !floor) return;
        try {
            if (appData.panels.some(p => p.panelName.toLowerCase() === panelName.toLowerCase())) {
                alert('A panel with this name already exists.');
                return;
            }
            const created = await apiCall(`/api/panel/${projectId}`, 'POST', { panelName, floor });
            // Since socket.io real-time updates are disabled, manually refresh the data
            appData = await apiCall(`/api/data/${projectId}`);
            renderSidebar();
            document.getElementById('new-panel-name').value='';
            document.getElementById('new-panel-floor').value='';
            addPanelModal.style.display='none';
        } catch(err) {
            // The apiCall function already shows an alert.
            console.error("Failed to add panel:", err);
        }
    });

    // --- PART LIBRARY LOGIC ---
    function renderPartsModal() {
        partsTableBody.innerHTML = "";
        Object.values(appData.parts).forEach(part => {
            const row = partsTableBody.insertRow();
            row.dataset.id = part.id;
            row.innerHTML = `
                <td>${part.part_number}</td>
                <td>${part.description}</td>
                <td>${part.category || ''}</td>
                <td>${part.cost != null ? '$' + part.cost.toFixed(2) : ''}</td>
            `;
            row.onclick = () => loadPartForEdit(part.id);
        });
        resetPartForm();
    }

    function resetPartForm() {
        partForm.reset();
        editingPartIdInput.value = "";
        partFormTitle.textContent = "Add New Part";
        deletePartBtn.style.visibility = "hidden";
    }

    function loadPartForEdit(id) {
        const part = appData.parts[id];
        if (!part) return;
        
        document.querySelectorAll("#parts-table tbody tr").forEach(tr => tr.style.backgroundColor = "");
        document.querySelector(`#parts-table tbody tr[data-id='${id}']`).style.backgroundColor = "var(--sidebar-item-hover-bg)";

        editingPartIdInput.value = id;
        partForm["part-number"].value = part.part_number;
        partForm["part-description"].value = part.description;
        partForm["part-category"].value = part.category || "";
        partForm["part-cost"].value = part.cost;
        partForm["part-country"].value = part.country_of_origin || "";
        partForm["part-cable"].value = part.cable_recommendation || "";
        partFormTitle.textContent = `Editing: ${part.part_number}`;
        deletePartBtn.style.visibility = "visible";
    }

    async function handlePartFormSubmit(event) {
        event.preventDefault();
        const id = editingPartIdInput.value;
        const data = {
            part_number: partForm["part-number"].value,
            description: partForm["part-description"].value,
            category: partForm["part-category"].value,
            cost: parseFloat(partForm["part-cost"].value) || null,
            country_of_origin: partForm["part-country"].value,
            cable_recommendation: partForm["part-cable"].value
        };

        const method = id ? "PUT" : "POST";
        const url = id ? `/api/parts/${projectId}/${id}` : `/api/parts/${projectId}`;
        const saved = await apiCall(url, method, data);
        // Optimistically merge into appData.parts
        appData.parts[saved.id] = saved;
        populatePartSelector();
        // If editing, keep context; if new, reset form and highlight
        if (!id) {
            resetPartForm();
            loadPartForEdit(saved.id);
        } else {
            loadPartForEdit(saved.id);
        }
        // Update any open points modal selectors referencing parts
        if (document.getElementById('point-part-number')) {
            const currentVal = pointForm['point-part-number'].value;
            populatePartSelector();
            pointForm['point-part-number'].value = currentVal || '';
        }
    }

    async function handleDeletePart() {
        if (!confirm("Are you sure you want to delete this part? This cannot be undone.")) return;
        const id = editingPartIdInput.value;
        await apiCall(`/api/parts/${projectId}/${id}`, "DELETE");
    }

    function handlePartsSearch() {
        const query = partsSearch.value.toLowerCase();
        document.querySelectorAll("#parts-table tbody tr").forEach(row => {
            const isVisible = row.textContent.toLowerCase().includes(query);
            row.style.display = isVisible ? "" : "none";
        });
    }

    function populatePartSelector() {
        const partSelector = document.getElementById('point-part-number');
        partSelector.innerHTML = '<option value="">None</option>';
        Object.values(appData.parts).forEach(part => {
            const option = document.createElement('option');
            option.value = part.id;
            option.textContent = `${part.part_number} - ${part.description}`;
            partSelector.appendChild(option);
        });
    }

    // --- POINT LIBRARY LOGIC ---
    function renderPointsModal() {
        pointsList.innerHTML = "";
        Object.values(appData.pointTemplates).sort((a, b) => a.name.localeCompare(b.name)).forEach(point => {
            const li = document.createElement("li");
            const sub_points_str = point.sub_points.map(sp => sp.point_type).join(', ');
            const displayName = point.display_name || point.name;
            li.innerHTML = `<span>${displayName} <small>(${sub_points_str})</small></span>`;
            li.dataset.id = point.id;
            li.onclick = () => loadPointForEdit(point.id);
            pointsList.appendChild(li)
        });
        resetPointForm()
    }

    function resetPointForm() {
        pointForm.reset();
        editingPointIdInput.value = "";
        pointFormTitle.textContent = "Add New Point";
        deletePointBtn.style.visibility = "hidden";
        subPointsContainer.innerHTML = '';
        renderSubPoints();
    }

    function renderSubPoints(sub_points = []) {
        subPointsContainer.innerHTML = '';
        const quantity = parseInt(pointForm['point-quantity'].value) || 1;
        for (let i = 0; i < quantity; i++) {
            const sub_point = sub_points[i] || {};
            const div = document.createElement('div');
            div.className = 'form-row';
            div.innerHTML = `
                <div class="form-group">
                    <label>Sub-Point ${i + 1} Name</label>
                    <input type="text" class="sub-point-name" value="${sub_point.name || ''}" required>
                </div>
                <div class="form-group">
                    <label>Sub-Point ${i + 1} Type</label>
                    <select class="sub-point-type" required>
                        <option value="AI" ${sub_point.point_type === 'AI' ? 'selected' : ''}>AI (Analog Input)</option>
                        <option value="AO" ${sub_point.point_type === 'AO' ? 'selected' : ''}>AO (Analog Output)</option>
                        <option value="DI" ${sub_point.point_type === 'DI' ? 'selected' : ''}>DI (Digital Input)</option>
                        <option value="DO" ${sub_point.point_type === 'DO' ? 'selected' : ''}>DO (Digital Output)</option>
                        <option value="Modbus" ${sub_point.point_type === 'Modbus' ? 'selected' : ''}>Modbus</option>
                        <option value="BACnet" ${sub_point.point_type === 'BACnet' ? 'selected' : ''}>BACnet</option>
                    </select>
                </div>
            `;
            subPointsContainer.appendChild(div);
        }
    }

    function loadPointForEdit(id) {
        resetPointForm();
        const point = appData.pointTemplates[id];
        if (!point) return;
        document.querySelectorAll("#points-list li").forEach(li => li.classList.remove("active"));
        document.querySelector(`#points-list li[data-id='${id}']`).classList.add("active");
        editingPointIdInput.value = id;
        pointForm["point-name"].value = point.name;
        pointForm['point-quantity'].value = point.quantity;
        pointForm['point-part-number'].value = point.part_id || '';
        renderSubPoints(point.sub_points);
        const displayName = point.display_name || point.name;
        pointFormTitle.textContent = `Editing: ${displayName}`;
        deletePointBtn.style.visibility = "visible"
    }
    async function handlePointFormSubmit(event) {
        event.preventDefault();
        const id = editingPointIdInput.value;
        const sub_points = Array.from(subPointsContainer.querySelectorAll('.form-row')).map(row => ({
            name: row.querySelector('.sub-point-name').value,
            point_type: row.querySelector('.sub-point-type').value
        }));
        const data = {
            name: pointForm["point-name"].value,
            quantity: parseInt(pointForm['point-quantity'].value),
            part_id: parseInt(pointForm['point-part-number'].value) || null,
            sub_points: sub_points
        };
        const method = id ? "PUT" : "POST",
            url = id ? `/api/points/${projectId}/${id}` : `/api/points/${projectId}`;
        const newPoint = await apiCall(url, method, data);
        // Integrate into appData without reloading all data
        appData.pointTemplates[newPoint.id] = newPoint;
        renderPointsModal();
        if (id) {
            loadPointForEdit(id);
        } else if (newPoint) {
            loadPointForEdit(newPoint.id);
        }
        // If editing equipment referencing points, refresh checkbox labels
        if (editingIdInput.value) {
            const currentType = form["equipment-type"].value;
            const selectedBefore = Array.from(checkboxContainer.querySelectorAll('input[type=checkbox]:checked')).map(cb=>parseInt(cb.value));
            renderCheckboxes(currentType);
            selectedBefore.forEach(pid=>{ const cb=document.getElementById(`point-${pid}`); if(cb) cb.checked=true; });
        }
    }
    async function handleDeletePoint() {
        if (!confirm("Are you sure you want to delete this point? This cannot be undone.")) return;
        const id = editingPointIdInput.value;
        await apiCall(`/api/points/${projectId}/${id}`, "DELETE");
    }

    // --- EQUIPMENT LIBRARY LOGIC ---
    function movePoint(pointId, action, quantity = 1) {
        const point = appData.pointTemplates[pointId];
        const sourceList = action === 'add' ? availablePointsList : assignedPointsList;
        const destList = action === 'add' ? assignedPointsList : availablePointsList;

        const li = document.createElement('li');
        li.dataset.id = point.id;
        
        const nameSpan = document.createElement('span');
        const sub_points_str = point.sub_points.map(sp => sp.point_type).join(', ');
        const displayName = point.display_name || point.name;
        nameSpan.innerHTML = `${displayName} <small>(${sub_points_str})</small>`;
        li.appendChild(nameSpan);

        const controls = document.createElement('span');

        if (action === 'add') {
            const quantityInput = document.createElement('input');
            quantityInput.type = 'number';
            quantityInput.value = quantity;
            quantityInput.min = 1;
            quantityInput.style.width = '50px';
            quantityInput.onchange = (e) => {
                li.dataset.quantity = e.target.value;
            };
            li.dataset.quantity = quantity;
            controls.appendChild(quantityInput);
        }

        const moveBtn = document.createElement('button');
        moveBtn.textContent = action === 'add' ? '−' : '+';
        moveBtn.onclick = () => movePoint(point.id, action === 'add' ? 'remove' : 'add');
        controls.appendChild(moveBtn);
        
        li.appendChild(controls);
        destList.appendChild(li);

        sourceList.querySelector(`li[data-id='${pointId}']`).remove();
    }

    function renderEquipmentLibraryModal() {
        templateList.innerHTML = "";
        Object.values(appData.equipmentTemplates).sort((a, b) => a.name.localeCompare(b.name)).forEach(template => {
            const li = document.createElement("li");
            li.innerHTML = `<span>${template.name}</span><span class="list-item-controls"><button title="Replicate">📋</button></span>`;
            li.dataset.id = template.type_key;
            li.onclick = () => loadTemplateForEdit(template.type_key);
            li.querySelector("button").onclick = async e => {
                e.stopPropagation();
                await apiCall(`/api/equipment_templates/${projectId}/${template.type_key}/replicate`, "POST");
                // After replication, reload the equipment templates
                const updatedData = await apiCall(`/api/data/${projectId}`);
                const prevSelected = form["equipment-type"].value;
                appData.equipmentTemplates = updatedData.equipmentTemplates;
                renderEquipmentLibraryModal();
                populateEquipmentTypes();
                if (prevSelected) form["equipment-type"].value = prevSelected;
            };
            templateList.appendChild(li)
        });
        resetTemplateForm();
    }

    function resetTemplateForm() {
        templateForm.reset();
        editingTemplateKeyInput.value = "";
        templateFormTitle.textContent = "Add New Equipment Type";
        templateForm.querySelector("button").textContent = "Save Template";
        document.querySelectorAll("#template-list li").forEach(li => li.classList.remove("active"));
        assignedPointsList.innerHTML = '';
        availablePointsList.innerHTML = '';
        Object.values(appData.pointTemplates).forEach(point => {
            const li = document.createElement('li');
            li.dataset.id = point.id;
            const nameSpan = document.createElement('span');
            const sub_points_str = point.sub_points.map(sp => sp.point_type).join(', ');
            const displayName = point.display_name || point.name;
            nameSpan.innerHTML = `${displayName} <small>(${sub_points_str})</small>`;
            li.appendChild(nameSpan);

            const addBtn = document.createElement('button');
            addBtn.textContent = '+';
            addBtn.onclick = () => movePoint(point.id, 'add');
            
            const controls = document.createElement('span');
            controls.appendChild(addBtn);
            li.appendChild(controls);
            availablePointsList.appendChild(li);
        });
    }

    function loadTemplateForEdit(id) {
        resetTemplateForm();
        const template = appData.equipmentTemplates[id];
        if (!template) return;

        document.querySelectorAll("#template-list li").forEach(li => li.classList.remove("active"));
        document.querySelector(`#template-list li[data-id='${id}']`).classList.add("active");
        editingTemplateKeyInput.value = id;
        templateForm["template-name"].value = template.name;
        templateForm["template-key"].value = template.type_key;
        templateForm["template-category"].value = template.category || "";  // Load category
        templateFormTitle.textContent = `Editing: ${template.name}`;
        templateForm.querySelector("button").textContent = "Update Template";

        const assignedPointIds = new Set(template.points.map(p => p.id));

        Object.values(appData.pointTemplates).forEach(point => {
            if (assignedPointIds.has(point.id)) {
                const templatePoint = template.points.find(p => p.id === point.id);
                movePoint(point.id, 'add', templatePoint.quantity);
            }
        });
    }
    async function handleTemplateFormSubmit(event) {
        event.preventDefault();
        const editingKey = editingTemplateKeyInput.value;
        const points = Array.from(assignedPointsList.querySelectorAll("li")).map(li => ({
            id: parseInt(li.dataset.id),
            quantity: parseInt(li.dataset.quantity)
        }));
        const data = {
            name: templateForm["template-name"].value,
            typeKey: templateForm["template-key"].value,
            category: templateForm["template-category"].value,  // Include category
            points: points
        };
        const url = editingKey ? `/api/equipment_templates/${projectId}/${editingKey}` : `/api/equipment_templates/${projectId}`,
            method = editingKey ? "PUT" : "POST";
        const oldKey = editingKey || data.typeKey;
        await apiCall(url, method, data);
        const updatedData = await apiCall(`/api/data/${projectId}`);
        appData.equipmentTemplates = updatedData.equipmentTemplates;
        // Refresh dropdown immediately, preserving current selection
        const currentSelected = form["equipment-type"].value;
        populateEquipmentTypes();
        // If current selection was the edited template and its key changed, switch to new key
        const newKey = data.typeKey;
        if (currentSelected === oldKey && oldKey !== newKey) {
            form["equipment-type"].value = newKey;
        } else if (currentSelected) {
            form["equipment-type"].value = currentSelected;
        }
        // Re-render library and reload edited template
        renderEquipmentLibraryModal();
        loadTemplateForEdit(newKey);
        // If user is editing equipment that uses this template, re-render its checkboxes
        const currentEditingId = parseInt(editingIdInput.value);
        if (currentEditingId) {
            const editingEquip = appData.scheduledEquipment.find(e => e.id === currentEditingId);
            if (editingEquip && (editingEquip.type === oldKey || editingEquip.type === newKey)) {
                const selectedPointsSnapshot = Array.from(checkboxContainer.querySelectorAll('input[type=checkbox]:checked')).map(cb=>parseInt(cb.value));
                checkboxContainer.innerHTML="";
                renderCheckboxes(newKey);
                selectedPointsSnapshot.forEach(pid=>{ const cb=document.getElementById(`point-${pid}`); if(cb) cb.checked=true; });
            }
        }
    }

    // --- MAIN APP LOGIC ---
    async function renderSidebar() {
        const myToken = ++sidebarRenderToken;
        // Take a snapshot so async updates don't mutate while we iterate
        const panelsSnapshot = [...appData.panels];
        const equipmentSnapshot = [...appData.scheduledEquipment];
        // Pre-fetch all point summaries concurrently
        const summaries = await Promise.all(panelsSnapshot.map(p => apiCall(`/api/panel/${p.id}/point_summary`).catch(()=>({}))));
        if (myToken !== sidebarRenderToken) return; // abort stale render
        panelList.innerHTML = "";
        panelsSnapshot.forEach((panel, idx) => {
            const equipmentInPanel = equipmentSnapshot.filter(item => item.panelName === panel.panelName);
            const details = document.createElement("details");
            details.open = true;
            const summary = document.createElement("summary");
            summary.textContent = `${panel.panelName} (${panel.floor})`;
            summary.dataset.panelName = panel.panelName;
            summary.onclick = () => selectPanel(panel.panelName, panel.floor);
            details.appendChild(summary);
            const pointSummary = summaries[idx] || {};
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'point-summary';
            summaryDiv.innerHTML = Object.entries(pointSummary).map(([key, value]) => `<span>${key}: ${value}</span>`).join('');
            details.appendChild(summaryDiv);
            const sublist = document.createElement("ul");
            sublist.className = "equipment-sublist";
            equipmentInPanel.forEach(item => {
                const listItem = document.createElement("li");
                const link = document.createElement("a");
                link.textContent = `${item.instanceName} (x${item.quantity})`;
                link.dataset.id = item.id;
                link.onclick = e => { e.stopPropagation(); loadEquipmentForEdit(item.id); };
                listItem.appendChild(link);
                sublist.appendChild(listItem);
            });
            details.appendChild(sublist);
            panelList.appendChild(details);
        });
    }

    function populateEquipmentTypes() {
        equipmentTypeSelect.innerHTML = '<option value="">--- Select ---</option>';
        Object.values(appData.equipmentTemplates).sort((a, b) => a.name.localeCompare(b.name)).forEach(template => {
            const option = document.createElement("option");
            option.value = template.type_key;
            option.textContent = template.name;
            equipmentTypeSelect.appendChild(option)
        })
    }

    function selectPanel(panelName, floor) {
        resetForm();
        panelNameInput.value = panelName;
        floorNameInput.value = floor;
        panelNameInput.readOnly = true;
        floorNameInput.readOnly = true;
        document.querySelectorAll(".panel-list summary").forEach(s => s.classList.remove("active"));
        const summaryEl = document.querySelector(`.panel-list summary[data-panel-name='${panelName}']`);
        summaryEl && summaryEl.classList.add("active");
        formTitle.textContent = `Add Equipment to ${panelName}`
    }

    function renderCheckboxes(equipmentTypeKey) {
        checkboxContainer.innerHTML = "";
        pointConfigContainer.style.display = "none";
        if (!equipmentTypeKey || !appData.equipmentTemplates[equipmentTypeKey]) return;
        const template = appData.equipmentTemplates[equipmentTypeKey];
        const pointGroups = template.points.reduce((acc, pointData) => {
            const point = appData.pointTemplates[pointData.id];
            if(point) {
                const point_with_quantity = {...point, quantity: pointData.quantity };
                for(const sp of point.sub_points) {
                    (acc[sp.point_type] || (acc[sp.point_type] = [])).push(point_with_quantity);
                }
            }
            return acc
        }, {});
        Object.keys(pointGroups).sort().forEach(groupName => {
            const fieldset = document.createElement("fieldset");
            const legend = document.createElement("legend");
            legend.textContent = groupName;
            fieldset.appendChild(legend);
            pointGroups[groupName].sort((a, b) => a.name.localeCompare(b.name)).forEach(point => {
                const itemDiv = document.createElement("div");
                itemDiv.className = "checkbox-item";
                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.id = `point-${point.id}`;
                checkbox.value = point.id;
                const label = document.createElement("label");
                label.htmlFor = `point-${point.id}`;
                const sub_points_str = point.sub_points.map(sp => sp.point_type).join(', ');
                const displayName = point.display_name || point.name;
                label.innerHTML = `${displayName} (x${point.quantity}) <small>(${sub_points_str})</small> `;
                itemDiv.append(checkbox, label);
                fieldset.appendChild(itemDiv)
            });
            checkboxContainer.appendChild(fieldset)
        });
        pointConfigContainer.style.display = "block"
    }

    function loadEquipmentForEdit(id) {
        const item = appData.scheduledEquipment.find(e => e.id === id);
        if (!item) return;
        resetForm();
        document.querySelectorAll(".equipment-sublist a").forEach(a => a.classList.remove("active"));
        document.querySelector(`.equipment-sublist a[data-id='${id}']`).classList.add("active");
        const panel = appData.panels.find(p => p.panelName === item.panelName);
        panelNameInput.value = item.panelName;
        floorNameInput.value = panel.floor;
        form["instance-name"].value = item.instanceName;
        quantityInput.value = item.quantity;
        form["equipment-type"].value = item.type;
        editingIdInput.value = item.id;
        renderCheckboxes(item.type);
        item.selectedPoints.forEach(pointId => {
            const checkbox = document.getElementById(`point-${pointId}`);
            if (checkbox) checkbox.checked = true
        });
        formTitle.textContent = `Editing: ${item.instanceName}`;
        mainHeader.textContent = `Editing Equipment`;
        submitButtonContainer.innerHTML = `<button type="submit" class="btn btn-update">Update Equipment</button><button type="button" id="save-preset-btn" class="btn btn-success" style="margin-left: 10px;">Save as Preset</button>`;
        // Re-bind event listener for the dynamically created Save Preset button
        document.getElementById('save-preset-btn').addEventListener('click', showSavePresetModal);
        panelNameInput.readOnly = false;
        floorNameInput.readOnly = false
    }

    function resetForm() {
        form.reset();
        editingIdInput.value = "";
        quantityInput.value = 1;
        pointConfigContainer.style.display = "none";
        checkboxContainer.innerHTML = "";
        document.querySelectorAll(".panel-list summary, .equipment-sublist a").forEach(el => el.classList.remove("active"));
        formTitle.textContent = "Add New Equipment";
        mainHeader.textContent = "Workspace";
        submitButtonContainer.innerHTML = `<button type="submit" class="btn btn-primary">Add Equipment to Schedule</button><button type="button" id="save-preset-btn" class="btn btn-success" style="margin-left: 10px;">Save as Preset</button>`;
        // Re-bind event listener for the dynamically created Save Preset button
        document.getElementById('save-preset-btn').addEventListener('click', showSavePresetModal);
        panelNameInput.readOnly = false;
        floorNameInput.readOnly = false
    }
    async function handleFormSubmit(event) {
        event.preventDefault();
        const editingId = parseInt(editingIdInput.value);
        const selectedPoints = Array.from(checkboxContainer.querySelectorAll("input:checked")).map(cb => parseInt(cb.value));
        const data = { panelName: panelNameInput.value, floor: floorNameInput.value, instanceName: form["instance-name"].value, quantity: parseInt(quantityInput.value), type: form["equipment-type"].value, selectedPoints };
        const url = editingId ? `/api/equipment/${projectId}/${editingId}` : `/api/equipment/${projectId}`;
        const method = editingId ? "PUT" : "POST";
        
        try {
            await apiCall(url, method, data);
            ignoreNextSocketUpdate = true; // Prevent socket from re-rendering over our optimistic update
            
            // Manually fetch the latest data to ensure UI consistency
            const updatedData = await apiCall(`/api/data/${projectId}`);
            appData.scheduledEquipment = updatedData.scheduledEquipment;
            appData.panels = updatedData.panels;
            
            // Re-render the sidebar to show the new/updated equipment
            renderSidebar();

            if (editingId) {
                // If we were editing, reload the form with the updated item's data
                const updatedItem = appData.scheduledEquipment.find(e => e.id === editingId);
                if (updatedItem) {
                    // Use a timeout to ensure the sidebar has re-rendered before loading the item
                    setTimeout(() => loadEquipmentForEdit(editingId), 50);
                }
            } else {
                // If we were adding a new item, just clear the equipment-specific fields
                form["instance-name"].value = '';
                form["equipment-type"].value = '';
                quantityInput.value = 1;
                renderCheckboxes(''); // This will hide and clear the checkboxes
            }
        } catch (error) {
            // The apiCall function already shows an alert, but we can log here for debugging
            console.error("Failed to submit equipment form:", error);
        }
    }

    function handleSearch() {
        const query = searchBar.value.toLowerCase();
        document.querySelectorAll(".panel-list details").forEach(details => {
            const items = Array.from(details.querySelectorAll("li"));
            const panelText = details.querySelector("summary").textContent.toLowerCase();
            let hasVisibleItem = false;
            items.forEach(li => {
                const isVisible = li.textContent.toLowerCase().includes(query);
                li.style.display = isVisible ? "" : "none";
                if(isVisible) hasVisibleItem = true;
            });
            details.style.display = panelText.includes(query) || hasVisibleItem ? "" : "none"
        })
    }
    
    function handleAvailablePointsSearch() {
        const query = availablePointsSearch.value.toLowerCase();
        document.querySelectorAll("#available-points-list li").forEach(li => {
            const isVisible = li.textContent.toLowerCase().includes(query);
            li.style.display = isVisible ? "flex" : "none";
        });
    }

    // --- EVENT LISTENERS ---
    pointForm.addEventListener("submit", handlePointFormSubmit);
    pointForm['point-quantity'].addEventListener('change', () => renderSubPoints());
    deletePointBtn.addEventListener("click", handleDeletePoint);
    templateForm.addEventListener("submit", handleTemplateFormSubmit);
    form.addEventListener("submit", handleFormSubmit);
    newPointBtn.addEventListener("click", resetPointForm);
    newTemplateBtn.addEventListener("click", resetTemplateForm);
    newPartBtn.addEventListener("click", resetPartForm);
    partForm.addEventListener("submit", handlePartFormSubmit);
    deletePartBtn.addEventListener("click", handleDeletePart);
    editPartBtn.addEventListener("click", () => {
        const partId = document.getElementById('point-part-number').value;
        if(partId) {
            loadPartForEdit(partId);
            partsLibraryModal.style.display = "flex";
        }
    });
    searchBar.addEventListener("input", handleSearch);
    availablePointsSearch.addEventListener('input', handleAvailablePointsSearch);
    partsSearch.addEventListener("input", handlePartsSearch);
    mainHeader.addEventListener("click", resetForm);
    equipmentTypeSelect.addEventListener("change", e => renderCheckboxes(e.target.value));
    
    // Project Summary button handler
    projectSummaryBtn.addEventListener("click", () => {
        window.location.href = `/summary/${projectId}`;
    });

    // Initialize application when page loads
    document.addEventListener("DOMContentLoaded", () => {
        loadInitialData();
        // initializeRealTime(); // Disabled for testing
        
        // Set current user for real-time features
        window.currentUser = '{{ current_user.username if current_user.is_authenticated else "Anonymous" }}';
    });
    let panelDeleteModal = document.getElementById('delete-panel-modal');
    let panelDeleteWarning = document.getElementById('delete-panel-warning');
    let panelDeleteConfirmInput = document.getElementById('delete-panel-confirm');
    let panelDeleteConfirmWordInput = document.getElementById('delete-panel-confirm-word');
    let deletePanelId = null; let deletePanelName = null;
    let renamePanelId = null; let renamePanelName = null;

    function showRenamePanel(panel) {
        renamePanelId = panel.id; 
        renamePanelName = panel.panelName;
        document.getElementById('rename-panel-info').textContent = `Renaming panel: "${panel.panelName}"`;
        document.getElementById('rename-panel-input').value = panel.panelName;
        document.getElementById('rename-panel-modal').style.display = 'flex';
        // Focus and select the text for easy editing
        setTimeout(() => {
            const input = document.getElementById('rename-panel-input');
            input.focus();
            input.select();
        }, 100);
    }

    function hideRenamePanelModal() {
        document.getElementById('rename-panel-modal').style.display = 'none';
    }

    async function confirmPanelRename() {
        const newName = document.getElementById('rename-panel-input').value.trim();
        
        if (!newName) {
            alert('Please enter a panel name.');
            return;
        }
        
        if (newName === renamePanelName) {
            hideRenamePanelModal();
            return;
        }

        // Check if panel name already exists in this project
        const existingPanel = appData.panels.find(p => p.panelName === newName && p.id !== renamePanelId);
        if (existingPanel) {
            alert('A panel with this name already exists in this project.');
            return;
        }

        try {
            const response = await fetch(`/api/panel/${projectId}/${renamePanelId}/rename`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: newName })
            });

            if (response.ok) {
                hideRenamePanelModal();
                // Refresh data and UI
                const updated = await apiCall(`/api/data/${projectId}`);
                appData.panels = updated.panels;
                appData.scheduledEquipment = updated.scheduledEquipment;
                renderSidebar();
                resetForm();
            } else {
                const data = await response.json().catch(() => ({ error: 'Rename failed' }));
                alert(data.error || 'Rename failed');
            }
        } catch (error) {
            alert('Network error. Please try again.');
        }
    }

    function showDeletePanel(panel){
      deletePanelId = panel.id; deletePanelName = panel.panelName;
      panelDeleteWarning.textContent = `This will remove panel "${panel.panelName}" and all its scheduled equipment. This cannot be undone.`;
      panelDeleteConfirmInput.value='';
      panelDeleteConfirmWordInput.value='';
      panelDeleteModal.style.display='flex';
    }

    document.getElementById('cancel-delete-panel').onclick = ()=>{ panelDeleteModal.style.display='none'; };

    // Add event listener for rename panel modal
    document.getElementById('rename-panel-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            confirmPanelRename();
        }
    });

    // Close rename panel modal when clicking outside
    document.getElementById('rename-panel-modal').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
            hideRenamePanelModal();
        }
    });

    document.getElementById('confirm-delete-panel').onclick = async ()=>{
      if(panelDeleteConfirmInput.value !== deletePanelName){ alert('Panel name mismatch'); return; }
      if(panelDeleteConfirmWordInput.value !== 'DELETE'){ alert('Please type DELETE to confirm.'); return; }
      const resp = await fetch(`/api/panel/${projectId}/${deletePanelId}`, { method:'DELETE', headers:{'Content-Type':'application/json'}, body: JSON.stringify({confirmName: deletePanelName, confirmWord: panelDeleteConfirmWordInput.value})});
      if(resp.ok){ panelDeleteModal.style.display='none'; const updated = await apiCall(`/api/data/${projectId}`); appData.panels = updated.panels; appData.scheduledEquipment = updated.scheduledEquipment; renderSidebar(); resetForm(); }
      else { const data = await resp.json().catch(()=>({error:'Delete failed'})); alert(data.error || 'Delete failed'); }
    };

    // Inject rename and delete buttons into sidebar after render
    const originalRenderSidebar = renderSidebar;
    renderSidebar = async function(){
      await originalRenderSidebar();
      // Add rename and delete controls to panel summaries
      document.querySelectorAll('#panel-list details').forEach(details => {
        const summary = details.querySelector('summary');
        if(summary && !summary.querySelector('.panel-controls')){
          const panelName = summary.dataset.panelName; const panel = appData.panels.find(p=>p.panelName===panelName);
          if(panel){
            // Create controls container
            const controls = document.createElement('div');
            controls.className = 'panel-controls';
            controls.style.display = 'inline-flex';
            controls.style.gap = '4px';
            controls.style.marginLeft = '8px';
            
            // Rename button
            const renameBtn = document.createElement('button');
            renameBtn.textContent='✏️';
            renameBtn.title='Rename Panel';
            renameBtn.className='panel-rename';
            renameBtn.style.background='transparent'; 
            renameBtn.style.border='none'; 
            renameBtn.style.cursor='pointer'; 
            renameBtn.style.color='#d69e2e';
            renameBtn.style.fontSize='12px';
            renameBtn.onclick = (e)=>{ e.stopPropagation(); showRenamePanel(panel); };
            
            // Delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent='✖';
            deleteBtn.title='Delete Panel';
            deleteBtn.className='panel-del';
            deleteBtn.style.background='transparent'; 
            deleteBtn.style.border='none'; 
            deleteBtn.style.cursor='pointer'; 
            deleteBtn.style.color='#b00';
            deleteBtn.style.fontSize='12px';
            deleteBtn.onclick = (e)=>{ e.stopPropagation(); showDeletePanel(panel); };
            
            controls.appendChild(renameBtn);
            controls.appendChild(deleteBtn);
            summary.appendChild(controls);
          }
        }
      });
    };
</script>

<!-- Real-time Notifications -->
<div id="notifications" class="notifications"></div>

<!-- Real-time Connection Indicator -->
<div id="real-time-indicator" class="real-time-indicator">
    Real-time sync
</div>

</body>
</html>